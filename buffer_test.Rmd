---
title: "Buffer test"
output:
  bookdown::html_document2:
    toc: yes
    toc_float: yes
    fig_caption: yes
  pdf_document:
    toc: yes
    number_sections: yes
    extra_dependencies: flafter
    includes:
      in_header: preamble.txe
---

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo = TRUE)
def_hook <- knit_hooks$get("output")
knit_hooks$set(output = function(x, options) {
  out <- def_hook(x, options)
  return(paste("\\begin{framed}\\begin{verbatim}", x, "\\end{verbatim}\\end{framed}", collapse = "\n"))
})
```


## Packages
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(sf)
library(terra)
library(tmap)
library(landscapemetrics)
library(gridExtra)
library(kableExtra)
```

load raster
```{r, echo=FALSE}
rin <- "data/mapbiomas_AP_utm_rio/utm_cover_AP_rio_2020.tif"

mapbiomas_2020 <- rast(rin)
# criar uma nova camada de floresta
floresta_2020 <- mapbiomas_2020
# Com valor de 0
values(floresta_2020) <- 0
# Atualizar categorias florestais agrupados com valor de 1
floresta_2020[mapbiomas_2020==3 | mapbiomas_2020==4] <- 1 
```

River lines
```{r, echo=FALSE, eval=TRUE, message=FALSE, warning=FALSE}
meuSIG <- "data/rivers.gpkg"
fs <- file.size(meuSIG)/(1024^2)
```

Load
```{r, message=FALSE, results = FALSE}
# pontos cada 5 km
rsm_31976 <- sf::st_read(meuSIG, layer = "midpoints") %>% 
  st_transform(31976) 
# linha central de rios
rsl_31976 <- sf::st_read(meuSIG, layer = "centerline") %>% 
  st_transform(31976) 
```


Plot
```{r, eval=FALSE}
# Passo necessario para agilizar o processamento
mapbiomas_2020_modal<-aggregate(mapbiomas_2020, fact=10, fun="modal")
# Plot
tm_shape(mapbiomas_2020_modal) +
  tm_raster(title = "Classe", style = "cat", palette = "Set3") + 
tm_shape(rsl_31976) + 
  tm_lines(col="blue") + 
tm_shape(rsm_31976) + 
  tm_dots(size = 0.2, col = "yellow") + 
tm_compass(position=c("left", "top")) +
tm_scale_bar(breaks = c(0, 25, 50), text.size = 1, 
             position=c("left", "bottom")) +
tm_layout(legend.position = c("right","top"), legend.bg.color="white")
```

Depois de executar ("run") o código acima, você deverá ver a figura a seguir.

```{r, echo=FALSE, fig.width=5, fig.height=5, fig.cap="Cobertura da terra ao redor do Rio Araguari em 2020. Mostrando os pontos de amostragem (pontos amarelas) cada 5 quilômetros ao longo do rio."}
# Passo necessario para agilizar o processamento
mapbiomas_2020_modal<-aggregate(mapbiomas_2020, fact=10, fun="modal")
# Plot
tm_shape(mapbiomas_2020_modal) +
  tm_raster(title = "Classe", style = "cat", palette = "Set3") + 
tm_shape(rsl_31976) + 
  tm_lines(col="blue") + 
tm_shape(rsm_31976) + 
  tm_dots(size = 0.2, col = "yellow") + 
tm_compass(position=c("left", "top")) +
tm_scale_bar(breaks = c(0, 25, 50), text.size = 1, 
             position=c("left", "bottom")) +
tm_layout(legend.position = c("right","top"), legend.bg.color="white")
```

--------------------------------------------


\newpage


## Landscape buffer

Para amostrar métricas de paisagem dentro de um certo buffer em torno de pontos de amostra, existe a função <code>sample_lsm()</code>.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
minha_amostra_1000 <- sample_lsm(floresta_2020, y = rsm_31976[1, ], 
                            size = 1000, shape = "circle", 
                            metric = "ca") 
```

Depois que executar ("run"), podemos olhar os dados com o codigo a seguir. 
```{r, eval=FALSE}
minha_amostra_1000
```

Os dados deve ter os valores:
```{r, echo=FALSE, message=FALSE, warning=FALSE}
minha_amostra_1000 %>% 
  kbl() %>%
  kable_styling(full_width = F,  latex_options = "hold_position")
```

Calculate proportion


For all 
```{r, echo=TRUE, message=FALSE, warning=FALSE}
minha_amostra_250 <- sample_lsm(floresta_2020, y = rsm_31976[1, ], 
                            size = 250, shape = "circle", 
                            metric = "ca") %>% 
  mutate(raio = 250)
minha_amostra_500 <- sample_lsm(floresta_2020, y = rsm_31976[1, ], 
                            size = 500, shape = "circle", 
                            metric = "ca")  %>% 
  mutate(raio = 500)
minha_amostra_1000 <- sample_lsm(floresta_2020, y = rsm_31976[1, ], 
                            size = 1000, shape = "circle", 
                            metric = "ca")  %>% 
  mutate(raio = 1000)
minha_amostra_2000 <- sample_lsm(floresta_2020, y = rsm_31976[1, ], 
                            size = 2000, shape = "circle", 
                            metric = "ca") %>% 
  mutate(raio = 2000)
minha_amostra_4000 <- sample_lsm(floresta_2020, y = rsm_31976[1, ], 
                            size = 4000, shape = "circle", 
                            metric = "ca")  %>% 
  mutate(raio = 4000)
minha_amostra_8000 <- sample_lsm(floresta_2020, y = rsm_31976[1, ], 
                            size = 8000, shape = "circle", 
                            metric = "ca")  %>% 
  mutate(raio = 8000)
minha_amostra_16000 <- sample_lsm(floresta_2020, y = rsm_31976[1, ], 
                            size = 16000, shape = "circle", 
                            metric = "ca")  %>% 
  mutate(raio = 16000)
```

join

```{r, echo=TRUE, message=FALSE, warning=FALSE}
bind_rows(minha_amostra_250, 
          minha_amostra_500, 
          minha_amostra_1000, 
          minha_amostra_2000, 
          minha_amostra_4000, 
          minha_amostra_8000, 
          minha_amostra_16000) -> amostras_metricas

```

calculate proportion
```{r}
amostras_metricas %>% 
  mutate(floresta_ha = if_else(class == 1, value, 0)) %>% 
  group_by(raio) %>% 
  summarise(area_total_ha = round(sum(value), 2), 
            area_floresta_ha = round(max(floresta_ha), 2)) %>% 
  mutate(proporcao_floresta = 
           round(area_floresta_ha / area_total_ha, 3), 
         porcentagem_floresta = 
           round((area_floresta_ha / area_total_ha)*100, 1)) -> amostras_metricas_resumo
```

make a graph
```{r}
amostras_metricas_resumo %>% 
  ggplot(aes(x=2*raio, y=porcentagem_floresta)) + 
  geom_point() + 
  labs(x = "extensão (metros)", y = "porcentagem de floresta")
```

make a better graph
```{r}
amostras_metricas_resumo %>% 
  ggplot(aes(x=(2*raio)/1000, y=porcentagem_floresta)) + 
  geom_point() + 
  stat_smooth(method = "lm", se = FALSE, color = "green") + 
  labs(x = "extensão (quilômetros)", y = "porcentagem de floresta")
```

compare linear and non linear
```{r}
amostras_metricas_resumo %>% 
  ggplot(aes(x=(2*raio)/1000, y=porcentagem_floresta)) + 
  geom_point() + 
  stat_smooth(method = "lm", color = "green") + 
  coord_cartesian(ylim = c(0,100)) +
  labs(title = "Modelo linear",
    x = "extensão (quilômetros)", 
    y = "porcentagem de floresta") -> fig_lm

amostras_metricas_resumo %>% 
  ggplot(aes(x=(2*raio)/1000, y=porcentagem_floresta)) + 
  geom_point() + 
  stat_smooth(method = "gam", formula = y ~ s(x, k = 5)) + 
  coord_cartesian(ylim = c(0,100)) +
  labs(title = "Modelo não-linear", 
       x = "extensão (quilômetros)", 
       y = "porcentagem de floresta") -> fig_gam

grid.arrange(fig_lm, fig_gam, nrow=1)
```